<!DOCTYPE html>
<html>
<head>
    <title>IONA's Circuit Dive - Beta v1.4 (HUD & Physics)</title>
    <style>
        body { 
            margin: 0; background: #000; overflow: hidden; 
            font-family: 'Courier New', monospace; user-select: none; touch-action: none;
        }
        canvas { display: block; margin: 0 auto; }
        
        #ui-layer {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            pointer-events: none; display: flex; flex-direction: column; justify-content: space-between;
        }

        /* Top HUD */
        .hud-top {
            padding: 10px 20px; display: flex; justify-content: space-between;
            background: linear-gradient(to bottom, rgba(0,0,0,0.95), transparent);
            color: #00ffff; text-shadow: 0 0 5px #00ffff; font-size: 16px;
        }
        .resource-box { display: flex; align-items: center; gap: 10px; }
        .icon-sm { width: 20px; height: 20px; border-radius: 50%; }

        /* Health Bar Container */
        #hp-wrapper { position: relative; width: 150px; height: 15px; margin-top: 5px; }
        #hp-container {
            width: 100%; height: 100%; border: 1px solid #00ffff; background: #000;
        }
        #hp-bar { width: 100%; height: 100%; background: #00ffff; transition: width 0.2s; }
        #hp-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #fff; font-weight: bold; text-shadow: 0 0 2px #000;
        }

        /* Start Screen */
        #start-screen {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: #050510; display: flex; flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 10;
        }
        #game-logo { width: 150px; margin-bottom: 20px; border-radius: 10px; box-shadow: 0 0 20px #00ffff; }
        
        .btn-main {
            padding: 15px 40px; font-size: 20px; color: #050510; background: #00ffff;
            border: none; font-family: inherit; font-weight: bold; cursor: pointer;
            box-shadow: 0 0 15px #00ffff; margin: 10px; min-width: 200px; transition: background 0.2s;
        }
        .btn-main:hover { background: #fff; }
        .btn-sec {
            padding: 10px 20px; font-size: 16px; color: #00ffff; background: transparent;
            border: 1px solid #00ffff; cursor: pointer; font-family: inherit; margin: 5px; transition: all 0.2s;
        }
        .btn-sec:hover { background: rgba(0, 255, 255, 0.1); }
        
        .btn-error { border-color: red !important; color: red !important; background: rgba(255,0,0,0.1) !important; }
        .btn-success { border-color: #00ff00 !important; color: #00ff00 !important; background: rgba(0,255,0,0.1) !important; }

        /* SHOP MODAL */
        #shop-screen {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.95); z-index: 15; pointer-events: auto;
            flex-direction: column; align-items: center; justify-content: center; color: white;
        }
        .shop-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 20px; margin-bottom: 20px; }
        .shop-item {
            border: 1px solid #333; padding: 20px; background: #111; text-align: center; width: 180px;
        }
        .shop-cost { color: #ffd700; margin: 10px 0; font-size: 14px; }
        .shop-cost.energy { color: #00ffff; }

        /* Boss HUD */
        #boss-hud { position: absolute; top: 80px; width: 100%; text-align: center; display: none; }
        #boss-name { color: #ff0055; font-size: 20px; font-weight: bold; text-shadow: 0 0 10px red; }
        #boss-hp-wrapper { position: relative; width: 250px; height: 15px; margin: 5px auto; }
        #boss-hp-container { width: 100%; height: 100%; border: 1px solid #ff0055; background: #220011; }
        #boss-hp-bar { width: 100%; height: 100%; background: #ff0055; transition: width 0.2s; }
        #boss-hp-text {
            position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            display: flex; align-items: center; justify-content: center;
            font-size: 10px; color: #fff; font-weight: bold; text-shadow: 0 0 2px #000;
        }

        /* Game Over */
        #game-over {
            display: none; position: absolute; top: 0; left: 0; width: 100%; height: 100%;
            background: rgba(0,0,0,0.9); color: white;
            flex-direction: column; align-items: center; justify-content: center;
            pointer-events: auto; z-index: 20;
        }

        #message {
            position: absolute; top: 40%; width: 100%; text-align: center;
            color: white; font-size: 32px; text-shadow: 0 0 20px white;
            opacity: 0; transition: opacity 0.5s;
        }
        #loading { color: #fff; position: absolute; top: 50%; left: 50%; transform: translate(-50%, -50%); }
    </style>
</head>
<body>

<div id="loading">INITIALIZING NEURAL LINK...</div>

<div id="shop-screen">
    <h1 style="color:#fff; text-shadow: 0 0 10px #00ffff;">NEURAL MARKET</h1>
    
    <div style="display: flex; gap: 30px; margin-bottom: 20px;">
        <div class="resource-box">
            <img src="./assets/aurum.png" class="icon-sm"> <span id="shop-aurum" style="color:#ffd700">0</span>
        </div>
        <div class="resource-box">
            <img src="./assets/energy.png" class="icon-sm"> <span id="shop-energy" style="color:#00ffff">0</span>
        </div>
    </div>

    <div class="shop-grid">
        <div class="shop-item">
            <div style="color:#00ffff; font-weight:bold;">HULL UPGRADE</div>
            <div style="font-size:12px; color:#888;">Increases Max HP</div>
            <div class="shop-cost energy">COST: <span id="cost-hp">100</span> ENERGY</div>
            <button id="btn-hp" class="btn-sec" onclick="buyUpgrade('hp', this)">UPGRADE</button>
            <div id="lvl-hp" style="font-size:10px; color:#666;">LVL: 0</div>
        </div>
        <div class="shop-item">
            <div style="color:#ff0055; font-weight:bold;">FIRE RATE</div>
            <div style="font-size:12px; color:#888;">Shoots Faster</div>
            <div class="shop-cost energy">COST: <span id="cost-fr">150</span> ENERGY</div>
            <button id="btn-fr" class="btn-sec" onclick="buyUpgrade('fireRate', this)">UPGRADE</button>
            <div id="lvl-fr" style="font-size:10px; color:#666;">LVL: 0</div>
        </div>
        <div class="shop-item">
            <div style="color:#ffd700; font-weight:bold;">AURUM PACK</div>
            <div style="font-size:12px; color:#888;">Microtransaction Sim</div>
            <div class="shop-cost">COST: $0.99</div>
            <button class="btn-sec" onclick="buyIAP(50, this)">BUY 50 AURUM</button>
        </div>
        <div class="shop-item">
            <div style="color:#fff; font-weight:bold;">ENERGY CONVERT</div>
            <div style="font-size:12px; color:#888;">Exchange Hard for Soft</div>
            <div class="shop-cost">COST: 1 AURUM</div>
            <button class="btn-sec" onclick="convertCurrency(this)">GET 20 ENERGY</button>
        </div>
    </div>

    <button class="btn-main" onclick="closeShop()">RETURN TO MENU</button>
</div>

<div id="start-screen">
    <img id="game-logo" src="" alt="SYNC STUDIOS"> 
    <h1 style="color:#fff; text-shadow: 0 0 10px #00ffff;">IONA'S CIRCUIT DIVE</h1>
    
    <div style="display: flex; gap: 40px; color: #fff; margin-bottom: 20px; font-size: 20px;">
        <div class="resource-box">
            <img src="./assets/aurum.png" class="icon-sm"> 
            <span style="color:#ffd700" id="menu-aurum">0</span>
        </div>
        <div class="resource-box">
            <img src="./assets/energy.png" class="icon-sm"> 
            <span style="color:#00ffff" id="menu-energy">0</span>
        </div>
    </div>

    <button class="btn-main" onclick="startGame()">INITIATE DIVE</button>
    <button class="btn-sec" onclick="openShop()">OPEN MARKET</button>
</div>

<div id="ui-layer" style="display:none;">
    <div class="hud-top">
        <div>
            <div>INTEGRITY</div>
            <div id="hp-wrapper">
                <div id="hp-container"><div id="hp-bar"></div></div>
                <div id="hp-text">100 / 100</div>
            </div>
        </div>
        
        <div style="display:flex; gap:15px;">
            <div class="resource-box">
                <img src="./assets/aurum.png" class="icon-sm"> <span id="hud-aurum">0</span>
            </div>
            <div class="resource-box">
                <img src="./assets/energy.png" class="icon-sm"> <span id="hud-energy">0</span>
            </div>
        </div>

        <div style="text-align:right">
            <div id="score">SCORE: 0</div>
            <div id="wave-info">WAVE 1</div>
        </div>
    </div>

    <div id="boss-hud">
        <div id="boss-name">TARGET</div>
        <div id="boss-hp-wrapper">
            <div id="boss-hp-container"><div id="boss-hp-bar"></div></div>
            <div id="boss-hp-text">0 / 0</div>
        </div>
    </div>

    <div id="message"></div>
</div>

<div id="game-over">
    <h1 style="color: #ff0055; text-shadow: 0 0 20px red;">CONNECTION SEVERED</h1>
    <h2 id="final-score">SCORE: 0</h2>
    <div style="display: flex; gap: 20px; margin: 20px;">
        <div>AURUM: <span id="end-aurum" style="color:#ffd700">0</span></div>
        <div>ENERGY: <span id="end-energy" style="color:#00ffff">0</span></div>
    </div>
    <div style="color: #aaa; margin-bottom: 20px;">(Resources saved to Bank)</div>
    <button class="btn-main" onclick="location.reload()">RECONNECT</button>
</div>

<canvas id="gameCanvas"></canvas>

<script>
    const canvas = document.getElementById('gameCanvas');
    const ctx = canvas.getContext('2d');
    canvas.width = window.innerWidth > 600 ? 480 : window.innerWidth;
    canvas.height = window.innerHeight;

    // --- SAVE & ECONOMY SYSTEM ---
    let savedData = JSON.parse(localStorage.getItem('iona_circuit_save_v1')) || { 
        aurum: 0, 
        energy: 0,
        upgrades: { hp: 0, fireRate: 0 } 
    };
    if(!savedData.upgrades) savedData.upgrades = { hp: 0, fireRate: 0 };
    let bank = savedData;

    function saveGame() {
        localStorage.setItem('iona_circuit_save_v1', JSON.stringify(bank));
        updateMenuUI();
    }

    function updateMenuUI() {
        document.getElementById('menu-aurum').innerText = bank.aurum;
        document.getElementById('menu-energy').innerText = bank.energy;
        document.getElementById('shop-aurum').innerText = bank.aurum;
        document.getElementById('shop-energy').innerText = bank.energy;
        
        const hpCost = 100 + (bank.upgrades.hp * 50);
        const frCost = 150 + (bank.upgrades.fireRate * 75);
        document.getElementById('cost-hp').innerText = hpCost;
        document.getElementById('cost-fr').innerText = frCost;
        document.getElementById('lvl-hp').innerText = "LVL: " + bank.upgrades.hp;
        document.getElementById('lvl-fr').innerText = "LVL: " + bank.upgrades.fireRate;
    }

    function openShop() { document.getElementById('shop-screen').style.display = 'flex'; updateMenuUI(); }
    function closeShop() { document.getElementById('shop-screen').style.display = 'none'; }

    function flashButton(btn, success) {
        btn.classList.add(success ? 'btn-success' : 'btn-error');
        setTimeout(() => { btn.classList.remove('btn-success', 'btn-error'); }, 500);
    }

    function buyUpgrade(type, btn) {
        if(type === 'hp') {
            const cost = 100 + (bank.upgrades.hp * 50);
            if(bank.energy >= cost) {
                bank.energy -= cost;
                bank.upgrades.hp++;
                saveGame();
                flashButton(btn, true);
            } else flashButton(btn, false);
        }
        if(type === 'fireRate') {
            const cost = 150 + (bank.upgrades.fireRate * 75);
            if(bank.energy >= cost) {
                bank.energy -= cost;
                bank.upgrades.fireRate++;
                saveGame();
                flashButton(btn, true);
            } else flashButton(btn, false);
        }
    }

    function buyIAP(amount, btn) {
        if(confirm("Confirm purchase of " + amount + " Aurum for $0.99?")) {
            bank.aurum += amount;
            saveGame();
            flashButton(btn, true);
        }
    }

    function convertCurrency(btn) {
        if(bank.aurum >= 1) {
            bank.aurum -= 1;
            bank.energy += 20; 
            saveGame();
            flashButton(btn, true);
        } else flashButton(btn, false);
    }

    // --- ASSETS ---
    const assets = {};
    const imageSources = {
        player: './assets/GuardianIONA.png',
        bg: './assets/bg.png', 
        logo: './assets/LogoSyncStudios.png',
        enemy1: './assets/enemy1.png',
        enemy2: './assets/enemy2.png',
        enemy3: './assets/enemy3.png',
        enemy4: './assets/enemy4.png',
        boss1: './assets/PrimordialOfWar.png',
        boss2: './assets/PrimordialOfDeceit.png',
        boss3: './assets/PrimordialOfPlague.png',
        boss4: './assets/PrimordialOfGreed.png',
        healing: './assets/GlyphBari.png',
        timeSlow: './assets/GlyphSlow.png', 
        aurum: './assets/aurum.png',
        energy: './assets/energy.png'
    };

    let assetsLoaded = 0;
    const totalAssets = Object.keys(imageSources).length;

    function loadAssets(callback) {
        for (let key in imageSources) {
            const img = new Image();
            img.src = imageSources[key];
            img.onload = () => { assetsLoaded++; checkLoad(); };
            img.onerror = () => { assetsLoaded++; checkLoad(); };
            assets[key] = img;
        }
        function checkLoad() {
            if (assetsLoaded === totalAssets) {
                document.getElementById('loading').style.display = 'none';
                if(assets.logo) document.getElementById('game-logo').src = assets.logo.src;
                updateMenuUI();
                callback();
            }
        }
    }
    function isDrawable(img) { return img && img.complete && img.naturalHeight !== 0; }

    // --- GAME LOGIC ---
    let lastTime = 0;
    const STATE = { MENU: 0, WAVE: 1, BOSS_WARNING: 2, BOSS_FIGHT: 3, GAME_OVER: 4 };
    
    const gameState = {
        mode: STATE.MENU,
        level: 1,
        player: { x: canvas.width/2, y: canvas.height-120, hp: 100, maxHp: 100 },
        score: 0,
        runAurum: 0,
        runEnergy: 0,
        bgOffsetY: 0,
        gameSpeed: 300, 
        timeScale: 1.0, 
        slowTimer: 0,
        playerProjectiles: [],
        enemyProjectiles: [],
        enemies: [],
        items: [],
        particles: [],
        boss: null,
        waveTimer: 0,
        waveDuration: 20, 
        input: { isShooting: false, lastShot: 0 }
    };

    // --- INPUT ---
    let inputDrag = { active: false, lastX: 0, lastY: 0, id: null };
    
    const handleStart = (x, y, id=0) => { 
        if(gameState.mode === STATE.MENU) return;
        if(inputDrag.active) return;
        inputDrag.active = true; 
        inputDrag.lastX = x; 
        inputDrag.lastY = y; 
        inputDrag.id = id;
        gameState.input.isShooting = true; 
    };
    
    const handleMove = (x, y, id=0) => {
        if(inputDrag.active && inputDrag.id === id) {
            gameState.player.x += (x - inputDrag.lastX);
            gameState.player.y += (y - inputDrag.lastY);
            inputDrag.lastX = x; inputDrag.lastY = y;
        }
    };
    
    const handleEnd = (id=0) => { 
        if(inputDrag.id === id) {
            inputDrag.active = false; 
            gameState.input.isShooting = false; 
        }
    };

    window.addEventListener('mousedown', e => handleStart(e.clientX, e.clientY));
    window.addEventListener('mousemove', e => handleMove(e.clientX, e.clientY));
    window.addEventListener('mouseup', () => handleEnd(0));
    canvas.addEventListener('touchstart', e => { 
        e.preventDefault(); 
        for(let i=0; i<e.changedTouches.length; i++) {
            let t = e.changedTouches[i];
            handleStart(t.clientX, t.clientY, t.identifier);
        }
    }, {passive: false});
    canvas.addEventListener('touchmove', e => { 
        e.preventDefault(); 
        for(let i=0; i<e.changedTouches.length; i++) {
            let t = e.changedTouches[i];
            handleMove(t.clientX, t.clientY, t.identifier);
        }
    }, {passive: false});
    canvas.addEventListener('touchend', e => {
        for(let i=0; i<e.changedTouches.length; i++) handleEnd(e.changedTouches[i].identifier);
    });

    function startGame() {
        document.getElementById('start-screen').style.display = 'none';
        document.getElementById('shop-screen').style.display = 'none';
        document.getElementById('ui-layer').style.display = 'block';
        
        const bonusHP = bank.upgrades.hp * 20;
        const fireRateReduction = Math.min(50, bank.upgrades.fireRate * 5);
        
        gameState.mode = STATE.WAVE;
        gameState.level = 1;
        gameState.score = 0;
        gameState.runAurum = 0;
        gameState.runEnergy = 0;
        gameState.player.maxHp = 100 + bonusHP;
        gameState.player.hp = gameState.player.maxHp;
        gameState.fireRate = 100 - fireRateReduction;
        gameState.enemies = []; gameState.items = []; gameState.playerProjectiles = []; gameState.enemyProjectiles = [];
        gameState.waveTimer = 0;
        
        lastTime = performance.now();
        updateHUD();
    }

    function spawnLoot(x, y) {
        const rand = Math.random();
        let type = ''; let img = null;
        if (rand < 0.08) { type = 'aurum'; img = assets.aurum; }
        else if (rand < 0.23) { type = 'energy'; img = assets.energy; }
        else if (rand < 0.28) { type = 'timeSlow'; img = assets.timeSlow; }
        else if (rand < 0.38) { type = 'healing'; img = assets.healing; }

        if (type) gameState.items.push({ x: x, y: y, type: type, img: img, w: 40, h: 40, speed: 150 });
    }

    function collectItem(item) {
        if(item.type === 'healing') {
            gameState.player.hp = Math.min(gameState.player.hp + 25, gameState.player.maxHp);
            showMessage("REPAIR +25%", "#00ff00");
        } 
        else if (item.type === 'aurum') {
            gameState.runAurum += 1; 
            showMessage("+1 AURUM", "#ffd700");
        }
        else if (item.type === 'energy') {
            gameState.runEnergy += 5;
            showMessage("+5 ENERGY", "#00ffff");
        }
        else if (item.type === 'timeSlow') {
            gameState.slowTimer = 5.0; 
            gameState.timeScale = 0.5;
            showMessage("CHRONO-BREACH ACTIVATED", "#00ffff");
        }
        updateHUD();
        item.collected = true;
    }

    function updateHUD() {
        document.getElementById('hp-bar').style.width = (gameState.player.hp / gameState.player.maxHp * 100) + "%";
        // NEW: Update Text
        document.getElementById('hp-text').innerText = Math.ceil(gameState.player.hp) + " / " + gameState.player.maxHp;
        
        document.getElementById('hud-aurum').innerText = gameState.runAurum;
        document.getElementById('hud-energy').innerText = gameState.runEnergy;
        document.getElementById('score').innerText = "SCORE: " + gameState.score;
    }

    function showMessage(text, color) {
        const msg = document.getElementById('message');
        msg.innerText = text; msg.style.color = color; msg.style.opacity = 1;
        setTimeout(() => msg.style.opacity = 0, 1500);
    }

    function startBossSequence() {
        gameState.mode = STATE.BOSS_WARNING;
        gameState.enemies = []; gameState.enemyProjectiles = [];
        showMessage("WARNING: PRIMORDIAL DETECTED", "red");
        setTimeout(spawnBoss, 2000);
    }

    function spawnBoss() {
        gameState.mode = STATE.BOSS_FIGHT;
        const index = Math.min(gameState.level, 4);
        const names = ["", "PRIMORDIAL OF WAR", "PRIMORDIAL OF DECEIT", "PRIMORDIAL OF PLAGUE", "PRIMORDIAL OF GREED"];
        
        document.getElementById('boss-hud').style.display = 'block';
        document.getElementById('boss-name').innerText = names[index];
        document.getElementById('boss-hp-bar').style.width = '100%';
        
        const bossMaxHp = 800 * gameState.level;
        document.getElementById('boss-hp-text').innerText = bossMaxHp + " / " + bossMaxHp;

        gameState.boss = {
            x: canvas.width/2, y: 100, w: 120, h: 120,
            hp: bossMaxHp, maxHp: bossMaxHp,
            img: assets['boss'+index], dir: 1, attackTimer: 0, pattern: 0
        };
    }

    function updateGame(dt) {
        if(gameState.mode === STATE.MENU || gameState.mode === STATE.GAME_OVER) return;

        if(gameState.slowTimer > 0) {
            gameState.slowTimer -= dt;
            if(gameState.slowTimer <= 0) {
                gameState.timeScale = 1.0;
                showMessage("TIME SYNC RESTORED", "#fff");
            }
        }
        const gameDt = dt * gameState.timeScale; 

        // CLAMP PLAYER Y TO PREVENT FLYING BEHIND BOSS
        gameState.player.x = Math.max(30, Math.min(canvas.width-30, gameState.player.x));
        gameState.player.y = Math.max(180, Math.min(canvas.height-50, gameState.player.y));

        // BG Scroll
        if(gameState.mode === STATE.WAVE) {
            gameState.bgOffsetY += gameState.gameSpeed * gameDt;
            if(gameState.bgOffsetY >= canvas.height) gameState.bgOffsetY = 0;
            gameState.waveTimer += gameDt;
            if(gameState.waveTimer > gameState.waveDuration) {
                startBossSequence(); 
                gameState.waveTimer = 0;
            }
        }

        // Shooting
        if(gameState.input.isShooting && gameState.mode !== STATE.BOSS_WARNING) {
            const now = Date.now();
            if(now - gameState.input.lastShot > (gameState.fireRate || 100)) { 
                gameState.playerProjectiles.push({ x: gameState.player.x, y: gameState.player.y - 40, active: true });
                gameState.input.lastShot = now;
            }
        }

        if(gameState.mode === STATE.WAVE && Math.random() < (1.0 * gameDt)) { 
            const types = ['enemy1', 'enemy2', 'enemy3', 'enemy4'];
            gameState.enemies.push({
                x: Math.random()*(canvas.width-50)+25, y: -50,
                img: assets[types[Math.floor(Math.random()*types.length)]],
                hp: 15 * gameState.level,
                speed: 150 + (Math.random()*100),
                w: 50, h: 50
            });
        }

        // Projectiles
        gameState.playerProjectiles.forEach(p => { p.y -= 600 * dt; if(p.y < 0) p.active = false; });
        
        gameState.enemyProjectiles.forEach(p => {
            p.x += (p.vx || 0) * gameDt; 
            // FIXED: Speed increased from 200 to 450 to overtake enemies
            p.y += Math.abs(p.vy || 450) * gameDt;

            if(Math.hypot(p.x - gameState.player.x, p.y - gameState.player.y) < 25) {
                gameState.player.hp -= 10; updateHUD(); p.active = false;
                document.body.style.backgroundColor = "#550000";
                setTimeout(()=>document.body.style.backgroundColor="#000", 50);
            }
            gameState.playerProjectiles.forEach(pp => {
                if(pp.active && p.active && Math.hypot(pp.x-p.x, pp.y-p.y) < 20) {
                    pp.active = false; p.active = false;
                    gameState.score += 10;
                    gameState.particles.push({x:p.x, y:p.y, vx:0, vy:0, life:0.2, color:'#fff'});
                }
            });
            if(p.y > canvas.height) p.active = false;
        });

        if(gameState.mode === STATE.BOSS_FIGHT && gameState.boss) {
            const b = gameState.boss;
            b.x += (150 * b.dir) * gameDt;
            if(b.x > canvas.width-60 || b.x < 60) b.dir *= -1;
            
            b.attackTimer += gameDt;
            if(b.attackTimer > 0.8) {
                if(Math.random()<0.3) b.pattern = Math.floor(Math.random()*3);
                
                if(b.pattern===0) { // Spread
                    for(let i=-2; i<=2; i++) gameState.enemyProjectiles.push({x:b.x, y:b.y+60, vx:i*100, vy:300, color:'#8a2be2', active:true});
                } else if(b.pattern===1) { // Aimed
                    const ang = Math.atan2(gameState.player.y-b.y, gameState.player.x-b.x);
                    gameState.enemyProjectiles.push({x:b.x, y:b.y+60, vx:Math.cos(ang)*400, vy:Math.sin(ang)*400, color:'#39ff14', active:true});
                } else { // Rain
                    for(let k=0; k<3; k++) gameState.enemyProjectiles.push({x:Math.random()*canvas.width, y:-20, vx:0, vy:350, color:'#ff0055', active:true});
                }
                b.attackTimer = 0;
            }
            
            gameState.playerProjectiles.forEach(p => {
                if(p.active && Math.abs(p.x-b.x)<60 && Math.abs(p.y-b.y)<60) {
                    b.hp -= 10; p.active = false;
                    document.getElementById('boss-hp-bar').style.width = (b.hp/b.maxHp*100)+"%";
                    // Update Boss Text
                    document.getElementById('boss-hp-text').innerText = Math.ceil(b.hp) + " / " + b.maxHp;

                    if(b.hp <= 0) {
                        gameState.score += 5000;
                        gameState.level++;
                        gameState.mode = STATE.WAVE;
                        document.getElementById('boss-hud').style.display = 'none';
                        document.getElementById('wave-info').innerText = "WAVE "+gameState.level;
                        showMessage("TARGET NEUTRALIZED", "#fff");
                        bank.aurum += 3; showMessage("+3 AURUM (BOSS)", "#ffd700");
                        updateHUD();
                    }
                }
            });
        }

        gameState.enemies.forEach(e => {
            e.y += e.speed * gameDt;
            if(Math.random() < 0.5 * gameDt) gameState.enemyProjectiles.push({x:e.x, y:e.y+30, color:'#39ff14', active:true});
            
            gameState.playerProjectiles.forEach(p => {
                if(p.active && Math.abs(p.x-e.x)<30 && Math.abs(p.y-e.y)<30) {
                    e.dead = true; p.active = false;
                    gameState.score += 100;
                    spawnLoot(e.x, e.y);
                }
            });
            if(!e.dead && Math.hypot(e.x-gameState.player.x, e.y-gameState.player.y)<40) {
                gameState.player.hp -= 20; updateHUD(); e.dead = true;
                document.body.style.backgroundColor = "#550000";
                setTimeout(()=>document.body.style.backgroundColor="#000", 50);
            }
        });

        gameState.items.forEach(i => {
            i.y += i.speed * gameDt;
            if(Math.hypot(i.x-gameState.player.x, i.y-gameState.player.y)<40 && !i.collected) collectItem(i);
        });

        gameState.playerProjectiles = gameState.playerProjectiles.filter(p=>p.active);
        gameState.enemyProjectiles = gameState.enemyProjectiles.filter(p=>p.active);
        gameState.enemies = gameState.enemies.filter(e=>!e.dead && e.y < canvas.height);
        gameState.items = gameState.items.filter(i=>!i.collected && i.y < canvas.height);
        gameState.particles.forEach(p => p.life -= dt);
        gameState.particles = gameState.particles.filter(p=>p.life>0);

        if(gameState.player.hp <= 0) {
            gameState.mode = STATE.GAME_OVER;
            document.getElementById('game-over').style.display = 'flex';
            document.getElementById('final-score').innerText = "SCORE: " + gameState.score;
            document.getElementById('end-aurum').innerText = gameState.runAurum;
            document.getElementById('end-energy').innerText = gameState.runEnergy;
            
            bank.aurum += gameState.runAurum;
            bank.energy += gameState.runEnergy;
            saveGame();
        }
    }

    function draw() {
        ctx.clearRect(0,0,canvas.width,canvas.height);
        if(gameState.mode === STATE.MENU) return;

        if(isDrawable(assets.bg)) {
            ctx.drawImage(assets.bg, 0, gameState.bgOffsetY, canvas.width, canvas.height);
            ctx.drawImage(assets.bg, 0, gameState.bgOffsetY - canvas.height, canvas.width, canvas.height);
        }

        gameState.items.forEach(i => {
            if(isDrawable(i.img)) {
                // FIXED: Force square aspect ratio 40x40
                ctx.drawImage(i.img, i.x-20, i.y-20, 40, 40);
            }
            else { ctx.fillStyle='yellow'; ctx.fillRect(i.x-10, i.y-10, 20, 20); }
        });

        if(isDrawable(assets.player)) ctx.drawImage(assets.player, gameState.player.x-30, gameState.player.y-30, 60, 60);

        if(gameState.mode === STATE.BOSS_FIGHT && gameState.boss && isDrawable(gameState.boss.img)) {
            ctx.drawImage(gameState.boss.img, gameState.boss.x-60, gameState.boss.y-60, 120, 120);
        }

        gameState.enemies.forEach(e => {
            if(isDrawable(e.img)) ctx.drawImage(e.img, e.x-25, e.y-25, 50, 50);
        });

        gameState.enemyProjectiles.forEach(p => {
            ctx.fillStyle = p.color;
            ctx.beginPath(); ctx.arc(p.x, p.y, 6, 0, Math.PI*2); ctx.fill();
        });
        ctx.fillStyle = '#00ffff';
        gameState.playerProjectiles.forEach(p => ctx.fillRect(p.x-2, p.y, 4, 15));
        
        gameState.particles.forEach(p => {
            ctx.fillStyle = p.color; ctx.fillRect(p.x, p.y, 4, 4);
        });

        if(gameState.slowTimer > 0) {
            ctx.fillStyle = 'rgba(0, 255, 255, 0.1)'; 
            ctx.fillRect(0,0,canvas.width, canvas.height);
        }
    }

    function loop(timestamp) {
        if (!lastTime) lastTime = timestamp;
        const dt = (timestamp - lastTime) / 1000;
        lastTime = timestamp;
        updateGame(dt);
        draw();
        requestAnimationFrame(loop);
    }
    
    loadAssets(() => { requestAnimationFrame(loop); });
</script>
</body>
</html>